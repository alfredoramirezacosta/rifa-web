<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>Sorteo</title>

<style>

body{
margin:0;
background:radial-gradient(circle,#111,#000);
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
height:100vh;
color:white;
font-family:Arial;
overflow:hidden;
}

/* CONTENEDOR RESPONSIVO */
.ruleta-container{
position:relative;
width:min(85vw,85vh);
aspect-ratio:1/1;
}

/* RULETA PERFECTAMENTE CIRCULAR */
canvas{
width:100%;
height:100%;
border-radius:50%;
box-shadow:
0 0 40px gold,
0 0 80px orange;
}

/* FLECHA */
#flecha{
position:absolute;
top:-25px;
left:50%;
transform:translateX(-50%);
font-size:50px;
color:red;
}

/* GANADOR */
#ganador{
margin-top:25px;
text-align:center;
animation:fade 1s ease;
}

.numero{
font-size:clamp(60px,10vw,120px);
color:gold;
font-weight:bold;
}

.nombre{
font-size:clamp(28px,4vw,50px);
}

.tel{
color:#aaa;
font-size:clamp(18px,2vw,25px);
}

@keyframes fade{
from{opacity:0;transform:scale(.7);}
to{opacity:1;transform:scale(1);}
}

</style>
</head>

<body>

<div class="ruleta-container">
<div id="flecha">â–¼</div>
<canvas id="ruleta"></canvas>
</div>

<div id="ganador"></div>

<audio id="spinSound"
src="https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-wheel-1934.mp3"></audio>

<audio id="winSound"
src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>

/* FIREBASE */

firebase.initializeApp({
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3"
});

const db=firebase.firestore();

/* CANVAS RESPONSIVO */

const canvas=document.getElementById("ruleta");
const ctx=canvas.getContext("2d");

function resize(){
const size=canvas.offsetWidth;
canvas.width=size;
canvas.height=size;
dibujar();
}

window.addEventListener("resize",resize);

let numeros=[];
let angulo=0;
let girando=false;

async function cargar(){

const snap=await db.collection("participantes").get();
numeros=[];

snap.forEach(d=>{
numeros.push(d.data().numero);
});

resize();
}

cargar();

/* DIBUJO */

function dibujar(){

if(!numeros.length) return;

let r=canvas.width/2;
let arc=(2*Math.PI)/numeros.length;

for(let i=0;i<numeros.length;i++){

ctx.beginPath();
ctx.fillStyle=i%2?"#e74c3c":"#f1c40f";

ctx.moveTo(r,r);
ctx.arc(r,r,r,
arc*i+angulo,
arc*(i+1)+angulo);

ctx.fill();

ctx.save();
ctx.translate(r,r);
ctx.rotate(arc*i+arc/2+angulo);

ctx.fillStyle="black";
ctx.font=`${r*0.08}px Arial`;
ctx.fillText("#"+numeros[i],r*0.7,5);

ctx.restore();
}
}

/* GIRO */

function girar(data){

if(girando) return;
girando=true;

document.getElementById("spinSound").play();

let index=numeros.indexOf(data.numero);
let arc=(2*Math.PI)/numeros.length;
let destino=(3*Math.PI/2)-(index*arc)-(arc/2);

let objetivo=angulo+(8*Math.PI)+destino;
let vel=0.35;

function anim(){

angulo+=vel;
vel*=0.992;

ctx.clearRect(0,0,canvas.width,canvas.height);
dibujar();

if(angulo<objetivo){
requestAnimationFrame(anim);
}else{

document.getElementById("spinSound").pause();
document.getElementById("winSound").play();

mostrar(data);
confeti();

girando=false;
}
}

anim();
}

/* GANADOR */

function mostrar(g){

let tel=g.telefono
? g.telefono.slice(0,6)+"****"
:"";

document.getElementById("ganador").innerHTML=
`
ðŸ† GANADOR ðŸ†
<div class="numero">#${g.numero}</div>
<div class="nombre">${g.nombre}</div>
<div class="tel">${tel}</div>
`;
}

/* CONFETI */

function confeti(){

for(let i=0;i<5;i++){
setTimeout(()=>{
confetti({
particleCount:200,
spread:160,
origin:{y:.6}
});
},i*400);
}
}

/* LISTENER */

db.collection("ganador")
.doc("actual")
.onSnapshot(doc=>{
if(!doc.exists)return;
girar(doc.data());
});

</script>

</body>
</html>
