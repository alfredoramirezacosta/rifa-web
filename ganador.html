<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ruleta Rifa</title>

<style>

body{
background:#111;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
flex-direction:column;
color:white;
font-family:Arial;
overflow:hidden;
}

canvas{
background:#222;
border-radius:50%;
box-shadow:0 0 40px black;
}

#flecha{
position:absolute;
top:40px;
font-size:60px;
color:red;
}

#ganador{
margin-top:20px;
font-size:40px;
color:gold;
}

</style>
</head>

<body>

<div id="flecha">â–¼</div>

<canvas id="ruleta" width="500" height="500"></canvas>

<div id="ganador"></div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>

const firebaseConfig={
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3",
storageBucket:"rifa-web-2b2f3.firebasestorage.app",
messagingSenderId:"440243321091",
appId:"1:440243321091:web:3a6a0a27e4e418cf6b9136"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const canvas=document.getElementById("ruleta");
const ctx=canvas.getContext("2d");

let numeros=[];
let anguloActual=0;
let girando=false;


/* =====================
DIBUJAR RULETA
===================== */

function dibujar(){

let arc=(2*Math.PI)/numeros.length;

for(let i=0;i<numeros.length;i++){

ctx.beginPath();
ctx.fillStyle=i%2?"#25D366":"#FFD700";

ctx.moveTo(250,250);
ctx.arc(
250,
250,
250,
arc*i+anguloActual,
arc*(i+1)+anguloActual
);

ctx.fill();

ctx.save();
ctx.translate(250,250);
ctx.rotate(arc*i+arc/2+anguloActual);

ctx.fillStyle="black";
ctx.font="18px Arial";
ctx.fillText(numeros[i],170,5);

ctx.restore();
}

}


/* =====================
OBTENER PARTICIPANTES
===================== */

async function cargarNumeros(){

let snap=
await db.collection("participantes").get();

numeros=[];

snap.forEach(d=>{
numeros.push(d.data().numero);
});

dibujar();
}

cargarNumeros();


/* =====================
GIRAR RULETA
===================== */

function girarRuleta(numeroGanador){

if(girando) return;
girando=true;

let index=numeros.indexOf(numeroGanador);

let arc=(2*Math.PI)/numeros.length;

let destino=
(3*Math.PI/2) -
(index*arc) -
(arc/2);

let vueltas=8;

let objetivo=
anguloActual+
(vueltas*2*Math.PI)+destino;

let velocidad=0.3;

function animar(){

anguloActual+=velocidad;

velocidad*=0.985;

ctx.clearRect(0,0,500,500);
dibujar();

if(anguloActual<objetivo){
requestAnimationFrame(animar);
}else{

mostrarGanador(numeroGanador);
lanzarConfeti();
girando=false;

}

}

animar();
}


/* =====================
GANADOR
===================== */

function mostrarGanador(num){

document.getElementById("ganador")
.innerHTML=`ðŸ† GANADOR #${num}`;

}


function lanzarConfeti(){

confetti({
particleCount:400,
spread:180,
origin:{y:0.6}
});

}


/* =====================
ESCUCHAR FIREBASE
===================== */

db.collection("ganador")
.doc("actual")
.onSnapshot(doc=>{

if(!doc.exists) return;

let ganador=doc.data().numero;

girarRuleta(ganador);

});

</script>

</body>
</html>
