<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Ganador</title>

<style>

body{
margin:0;
background:radial-gradient(circle,#111,#000);
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
min-height:100vh;
color:white;
font-family:Arial, Helvetica, sans-serif;
overflow:hidden;
padding:20px;
box-sizing:border-box;
}

/* CONTENEDOR RULETA */
.ruleta-container{
position:relative;
width:90vw;
max-width:500px;
aspect-ratio:1/1;
display:flex;
justify-content:center;
align-items:center;
margin:auto;
}

/* RULETA */
canvas{
width:100% !important;
height:100% !important;
border-radius:50%;
box-shadow:
0 0 40px orange,
0 0 80px rgba(255,140,0,.6);
}

/* FLECHA */
.pointer{
position:absolute;
top:-15px;
left:50%;
transform:translateX(-50%);
width:0;
height:0;
border-left:15px solid transparent;
border-right:15px solid transparent;
border-bottom:25px solid red;
z-index:10;
}

/* GANADOR */
#ganador{
margin-top:30px;
text-align:center;
animation:fadeIn 1s ease;
}

.numero{
font-size:60px;
font-weight:bold;
color:gold;
}

.nombre{
font-size:28px;
margin-top:10px;
}

@keyframes fadeIn{
from{opacity:0;transform:scale(.7)}
to{opacity:1;transform:scale(1)}
}

.confeti{
position:fixed;
width:10px;
height:10px;
background:red;
top:-10px;
animation:caer 3s linear forwards;
}

@keyframes caer{
to{
transform:translateY(110vh) rotate(720deg);
opacity:0;
}
}

</style>
</head>

<body>

<div class="ruleta-container">
<div class="pointer"></div>
<canvas id="ruleta"></canvas>
</div>

<div id="ganador"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>

const firebaseConfig={
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3",
storageBucket:"rifa-web-2b2f3.firebasestorage.app",
messagingSenderId:"440243321091",
appId:"1:440243321091:web:3a6a0a27e4e418cf6b9136"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const canvas=document.getElementById("ruleta");
const ctx=canvas.getContext("2d");

let participantes=[];
let anguloActual=0;

/* AJUSTAR RESOLUCI√ìN */
function resizeCanvas(){
canvas.width=canvas.offsetWidth;
canvas.height=canvas.offsetHeight;
dibujar();
}
window.addEventListener("resize",resizeCanvas);

/* CARGAR PARTICIPANTES */
db.collection("participantes")
.orderBy("numero")
.get()
.then(snapshot=>{

snapshot.forEach(doc=>{
participantes.push(doc.data());
});

resizeCanvas();
escucharGanador();

});

/* DIBUJAR RULETA */
function dibujar(){

let total=participantes.length;
if(!total)return;

let angulo=(2*Math.PI)/total;

for(let i=0;i<total;i++){

ctx.beginPath();
ctx.moveTo(canvas.width/2,canvas.height/2);

ctx.fillStyle=
i%2==0?"#111":"#222";

ctx.arc(
canvas.width/2,
canvas.height/2,
canvas.width/2,
angulo*i+anguloActual,
angulo*(i+1)+anguloActual
);

ctx.fill();

ctx.save();
ctx.translate(canvas.width/2,canvas.height/2);
ctx.rotate(angulo*i+angulo/2+anguloActual);

ctx.fillStyle="white";
ctx.font="bold 16px Arial";
ctx.fillText(
"#"+participantes[i].numero,
canvas.width/3,
5
);

ctx.restore();
}

}

/* ANIMACI√ìN GIRO */
function girarHasta(indice){

let total=participantes.length;
let angulo=(2*Math.PI)/total;

let destino=
(2*Math.PI*6)+
((3*Math.PI/2)-(indice*angulo));

let inicio=null;

function animar(t){

if(!inicio)inicio=t;

let progreso=(t-inicio)/5000;

if(progreso<1){

anguloActual=destino*easeOut(progreso);
ctx.clearRect(0,0,canvas.width,canvas.height);
dibujar();

requestAnimationFrame(animar);

}else{

anguloActual=destino;
dibujar();
confeti();
mostrar(participantes[indice]);

}

}

requestAnimationFrame(animar);
}

function easeOut(t){
return 1-Math.pow(1-t,4);
}

/* CONFETI */
function confeti(){

for(let i=0;i<120;i++){

let c=document.createElement("div");
c.className="confeti";

c.style.left=Math.random()*100+"vw";
c.style.background=
`hsl(${Math.random()*360},100%,50%)`;

c.style.animationDuration=
(2+Math.random()*2)+"s";

document.body.appendChild(c);

setTimeout(()=>c.remove(),4000);
}
}

/* MOSTRAR GANADOR */
function mostrar(g){

document.getElementById("ganador").innerHTML=
`
üèÜ GANADOR üèÜ
<div class="numero">#${g.numero}</div>
<div class="nombre">${g.nombre}</div>
`;
}

/* ESCUCHAR GANADOR AUTOM√ÅTICO */
function escucharGanador(){

db.collection("config")
.doc("ganador")
.onSnapshot(doc=>{

if(!doc.exists)return;

let numero=doc.data().numero;

let indice=
participantes.findIndex(
p=>p.numero==numero
);

if(indice>=0){
girarHasta(indice);
}

});

}

</script>

</body>
</html>
