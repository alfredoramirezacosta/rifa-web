<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gran Sorteo</title>

<style>

body{
margin:0;
background:#050505;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
flex-direction:column;
color:white;
font-family:Arial;
overflow:hidden;
}

/* Luces casino */
body::before{
content:"";
position:absolute;
width:200%;
height:200%;
background:
radial-gradient(circle,#ff000033 2%,transparent 3%);
background-size:40px 40px;
animation:luces 2s linear infinite;
z-index:-1;
}

@keyframes luces{
from{transform:rotate(0deg);}
to{transform:rotate(360deg);}
}

canvas{
border-radius:50%;
box-shadow:
0 0 40px gold,
0 0 80px red,
0 0 120px orange;
}

#flecha{
position:absolute;
top:30px;
font-size:70px;
color:red;
}

#ganador{
margin-top:25px;
font-size:50px;
color:gold;
font-weight:bold;
}

</style>
</head>

<body>

<div id="flecha">â–¼</div>

<canvas id="ruleta" width="600" height="600"></canvas>

<div id="ganador"></div>

<!-- sonidos -->
<audio id="spinSound"
src="https://assets.mixkit.co/sfx/preview/mixkit-slot-machine-wheel-1934.mp3"></audio>

<audio id="winSound"
src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>

/* ================= FIREBASE ================= */

const firebaseConfig={
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();


/* ================= RULETA ================= */

const canvas=document.getElementById("ruleta");
const ctx=canvas.getContext("2d");

let numeros=[];
let angulo=0;
let girando=false;

const spinSound=document.getElementById("spinSound");
const winSound=document.getElementById("winSound");


async function cargarNumeros(){

let snap=await db.collection("participantes").get();

numeros=[];

snap.forEach(d=>{
numeros.push(d.data().numero);
});

dibujar();
}

cargarNumeros();


function dibujar(){

let arc=(2*Math.PI)/numeros.length;

for(let i=0;i<numeros.length;i++){

ctx.beginPath();

ctx.fillStyle=
i%2?"#c0392b":"#f1c40f";

ctx.moveTo(300,300);
ctx.arc(
300,
300,
300,
arc*i+angulo,
arc*(i+1)+angulo
);

ctx.fill();

ctx.save();
ctx.translate(300,300);
ctx.rotate(arc*i+arc/2+angulo);

ctx.fillStyle="black";
ctx.font="20px Arial";
ctx.fillText(numeros[i],210,5);

ctx.restore();
}

}


/* ================= GIRO REAL ================= */

function girarRuleta(ganador){

if(girando) return;
girando=true;

spinSound.currentTime=0;
spinSound.play();

let index=numeros.indexOf(ganador);
let arc=(2*Math.PI)/numeros.length;

let destino=
(3*Math.PI/2) -
(index*arc) -
(arc/2);

let objetivo=
angulo+(10*Math.PI)+destino;

let velocidad=0.35;

function animar(){

angulo+=velocidad;

velocidad*=0.992;

ctx.clearRect(0,0,600,600);
dibujar();

if(angulo<objetivo){

requestAnimationFrame(animar);

}else{

spinSound.pause();
winSound.play();

mostrarGanador(ganador);
megaConfeti();

girando=false;
}

}

animar();
}


/* ================= GANADOR ================= */

function mostrarGanador(num){

document.getElementById("ganador")
.innerHTML=`ðŸ† GANADOR #${num}`;

}


/* ================= CONFETI ================= */

function megaConfeti(){

setInterval(()=>{
confetti({
particleCount:120,
spread:180,
origin:{y:Math.random()}
});
},400);

}


/* ================= FIREBASE LISTENER ================= */

db.collection("ganador")
.doc("actual")
.onSnapshot(doc=>{

if(!doc.exists) return;

girarRuleta(doc.data().numero);

});

</script>

</body>
</html>
