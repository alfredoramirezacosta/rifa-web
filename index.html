<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rifa</title>

<style>
body{
font-family:Arial;
background:#f2f2f2;
text-align:center;
}

.container{
background:white;
padding:20px;
margin:auto;
max-width:420px;
border-radius:10px;
box-shadow:0 0 10px rgba(0,0,0,.2);
}

.grid{
display:grid;
grid-template-columns:repeat(10,1fr);
gap:5px;
margin-top:15px;
}

.numero{
padding:8px;
background:#e0e0e0;
border-radius:6px;
cursor:pointer;
}

.ocupado{
background:red;
color:white;
cursor:not-allowed;
}

.seleccionado{
background:#25D366;
color:white;
}
</style>
</head>

<body>

<div class="container">

<h2>ðŸŽŸ Participa en la Rifa</h2>

<input id="nombre" placeholder="Nombre"><br><br>
<input id="telefono" placeholder="TelÃ©fono">

<h3>NÃºmeros disponibles</h3>
<div id="numeros" class="grid"></div>

<p id="contador"></p>

<button onclick="participar()">Confirmar</button>

</div>

<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
addDoc,
onSnapshot,
doc,
getDoc
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig={
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3",
storageBucket:"rifa-web-2b2f3.firebasestorage.app",
messagingSenderId:"440243321091",
appId:"1:440243321091:web:3a6a0a27e4e418cf6b9136"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let numeroSeleccionado=null;
const contenedor=document.getElementById("numeros");

/* ESTADO RIFA */
async function rifaAbierta(){
const ref=doc(db,"configuracion","estado");
const snap=await getDoc(ref);
if(!snap.exists()) return true;
return snap.data().abierto;
}

/* GRID NUMEROS */
function crearGrid(ocupados){

contenedor.innerHTML="";

for(let i=1;i<=100;i++){

let div=document.createElement("div");
div.textContent=i;
div.className="numero";

if(ocupados.includes(i)){
div.classList.add("ocupado");
}else{
div.onclick=()=>{
document.querySelectorAll(".numero")
.forEach(n=>n.classList.remove("seleccionado"));

div.classList.add("seleccionado");
numeroSeleccionado=i;
};
}

contenedor.appendChild(div);
}

document.getElementById("contador")
.innerText=`Disponibles: ${100-ocupados.length}`;
}

/* TIEMPO REAL */
onSnapshot(collection(db,"participantes"),snap=>{

let usados=[];

snap.forEach(doc=>{
usados.push(doc.data().numero);
});

crearGrid(usados);

});

/* REGISTRO */
window.participar=async()=>{

if(!(await rifaAbierta())){
alert("ðŸš« Rifa cerrada");
return;
}

const nombre=document.getElementById("nombre").value.trim();
const telefono=document.getElementById("telefono").value.trim();

if(!nombre||!telefono||!numeroSeleccionado){
alert("Completa todos los datos");
return;
}

await addDoc(collection(db,"participantes"),{
nombre,
telefono,
numero:numeroSeleccionado,
fecha:new Date()
});

const mensaje=
`Hola, apartÃ© el nÃºmero ${numeroSeleccionado}`;

window.location.href=
`https://wa.me/526624446775?text=${encodeURIComponent(mensaje)}`;

};

</script>
</body>
</html>
