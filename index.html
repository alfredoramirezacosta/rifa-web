<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Registro Rifa</title>

<style>

body{
font-family:Arial;
background:#f2f2f2;
text-align:center;
}

.container{
background:white;
padding:20px;
margin:auto;
max-width:420px;
border-radius:10px;
box-shadow:0 0 10px rgba(0,0,0,.2);
}

input{
width:90%;
padding:10px;
margin:5px;
font-size:16px;
}

button{
padding:12px;
background:#25D366;
color:white;
border:none;
border-radius:8px;
font-size:16px;
cursor:pointer;
}

.grid{
display:grid;
grid-template-columns:repeat(10,1fr);
gap:5px;
margin-top:15px;
}

.numero{
padding:8px;
background:#e0e0e0;
border-radius:6px;
cursor:pointer;
}

.ocupado{
background:red;
color:white;
cursor:not-allowed;
}

.seleccionado{
background:#25D366;
color:white;
}

</style>
</head>

<body>

<div class="container">

<h2>ðŸŽŸ Registro de Participante</h2>

<input id="nombre" placeholder="Nombre del participante">
<input id="telefono" placeholder="TelÃ©fono del participante">

<h3>Seleccionar nÃºmero</h3>

<div id="numeros" class="grid"></div>

<p id="contador"></p>

<button onclick="participar()">Registrar</button>

</div>

<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
addDoc,
onSnapshot,
doc,
getDoc
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig={
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3",
storageBucket:"rifa-web-2b2f3.firebasestorage.app",
messagingSenderId:"440243321091",
appId:"1:440243321091:web:3a6a0a27e4e418cf6b9136"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let numeroSeleccionado=null;
const contenedor=document.getElementById("numeros");


/* VERIFICAR SI RIFA ABIERTA */
async function rifaAbierta(){

const ref=doc(db,"configuracion","estado");
const snap=await getDoc(ref);

if(!snap.exists()) return true;

return snap.data().abierto;
}


/* CREAR GRID */
function crearGrid(ocupados){

contenedor.innerHTML="";

for(let i=1;i<=100;i++){

let div=document.createElement("div");
div.textContent=i;
div.className="numero";

if(ocupados.includes(i)){
div.classList.add("ocupado");
}else{
div.onclick=()=>{

document.querySelectorAll(".numero")
.forEach(n=>n.classList.remove("seleccionado"));

div.classList.add("seleccionado");
numeroSeleccionado=i;
};
}

contenedor.appendChild(div);
}

document.getElementById("contador")
.innerText=`Disponibles: ${100-ocupados.length}`;
}


/* ACTUALIZACION EN VIVO */
onSnapshot(collection(db,"participantes"),snap=>{

let usados=[];

snap.forEach(doc=>{
usados.push(doc.data().numero);
});

crearGrid(usados);

});


/* REGISTRAR PARTICIPANTE */
window.participar=async()=>{

if(!(await rifaAbierta())){
alert("ðŸš« La rifa estÃ¡ cerrada");
return;
}

const nombre=
document.getElementById("nombre").value.trim();

const telefono=
document.getElementById("telefono").value.trim();

if(!nombre||!telefono||!numeroSeleccionado){
alert("Completa todos los datos");
return;
}

/* GUARDAR */
await addDoc(collection(db,"participantes"),{
nombre,
telefono,
numero:numeroSeleccionado,
fecha:new Date()
});


/* MENSAJE AL CLIENTE */
const mensaje=
`ðŸŽŸ Registro exitoso

Nombre: ${nombre}
NÃºmero asignado: ${numeroSeleccionado}

Gracias por participar âœ…`;

const telefonoLimpio=
telefono.replace(/\D/g,'');

window.location.href=
`https://wa.me/52${telefonoLimpio}?text=${encodeURIComponent(mensaje)}`;


/* LIMPIAR FORMULARIO */
document.getElementById("nombre").value="";
document.getElementById("telefono").value="";
numeroSeleccionado=null;

};

</script>

</body>
</html>
