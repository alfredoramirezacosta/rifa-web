<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel Administrador Rifa</title>

<style>

body{
font-family:Arial;
text-align:center;
background:#111;
color:white;
}

button{
padding:12px 18px;
margin:8px;
font-size:16px;
cursor:pointer;
border:none;
border-radius:8px;
background:#25D366;
color:white;
}

button:hover{
opacity:.8;
}

table{
margin:auto;
border-collapse:collapse;
background:white;
color:black;
width:90%;
}

th,td{
padding:10px;
border:1px solid #ccc;
}

#animacionNumero{
font-size:110px;
margin:30px;
color:gold;
font-weight:bold;
}

.estado{
font-size:22px;
margin:10px;
}

</style>

</head>

<body>

<h1>ğŸ“Š PANEL ADMINISTRADOR</h1>

<button onclick="toggleRifa()">
ğŸ”“ Abrir / Cerrar Rifa
</button>

<h2 id="estadoRifa" class="estado"></h2>

<hr>

<button onclick="elegirGanador()">
ğŸ° SORTEAR GANADOR
</button>

<h1 id="animacionNumero">ğŸ°</h1>

<h2 id="ganador"></h2>

<hr>

<h3>ğŸ“‹ Participantes</h3>

<table>
<thead>
<tr>
<th>Nombre</th>
<th>TelÃ©fono</th>
<th>NÃºmero</th>
<th>Eliminar</th>
</tr>
</thead>

<tbody id="lista"></tbody>
</table>


<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,
collection,
onSnapshot,
deleteDoc,
doc,
getDoc,
setDoc,
getDocs
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


/* =========================
   FIREBASE
========================= */

const firebaseConfig={
apiKey:"AIzaSyCqVZwBX96EHfl3k__iqyc7rF1MZmSVpRI",
authDomain:"rifa-web-2b2f3.firebaseapp.com",
projectId:"rifa-web-2b2f3",
storageBucket:"rifa-web-2b2f3.firebasestorage.app",
messagingSenderId:"440243321091",
appId:"1:440243321091:web:3a6a0a27e4e418cf6b9136"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const tabla=document.getElementById("lista");


/* =========================
   PARTICIPANTES EN VIVO
========================= */

onSnapshot(collection(db,"participantes"),snap=>{

tabla.innerHTML="";

snap.forEach(d=>{

const data=d.data();

tabla.innerHTML+=`
<tr>
<td>${data.nombre}</td>
<td>${data.telefono}</td>
<td>#${data.numero}</td>
<td>
<button onclick="eliminar('${d.id}')">
âŒ
</button>
</td>
</tr>
`;

});

});


/* =========================
   ELIMINAR PARTICIPANTE
========================= */

window.eliminar=async(id)=>{
await deleteDoc(doc(db,"participantes",id));
};


/* =========================
   ABRIR / CERRAR RIFA
========================= */

window.toggleRifa=async()=>{

const ref=doc(db,"configuracion","estado");
const snap=await getDoc(ref);

let abierto=true;

if(snap.exists()){
abierto=snap.data().abierto;
}

await setDoc(ref,{
abierto:!abierto
});

};


/* =========================
   MOSTRAR ESTADO EN VIVO
========================= */

onSnapshot(doc(db,"configuracion","estado"),snap=>{

if(!snap.exists()) return;

document.getElementById("estadoRifa").innerText=
snap.data().abierto
? "ğŸŸ¢ RIFA ABIERTA"
: "ğŸ”´ RIFA CERRADA";

});


/* =========================
   ğŸ° SORTEO CASINO
========================= */

window.elegirGanador = async () => {

const snapshot =
await getDocs(collection(db,"participantes"));

let participantes=[];

snapshot.forEach(doc=>{
participantes.push(doc.data());
});

if(participantes.length===0){
alert("No hay participantes");
return;
}

const ganador=
participantes[
Math.floor(Math.random()*participantes.length)
];

const display=
document.getElementById("animacionNumero");

let numeros=
participantes.map(p=>p.numero);

let velocidad=40;
let vueltas=0;

const animar=setInterval(()=>{

display.innerText=
numeros[Math.floor(Math.random()*numeros.length)];

vueltas++;

if(vueltas>60){

clearInterval(animar);

display.innerText=
"ğŸ† "+ganador.numero;

guardarGanador(ganador);

}

},velocidad);

};


/* =========================
   GUARDAR GANADOR
========================= */

async function guardarGanador(ganador){

await setDoc(
doc(db,"ganador","actual"),
ganador
);

document.getElementById("ganador").innerHTML=
`
ğŸ† GANADOR<br>
${ganador.nombre}<br>
NÃºmero #${ganador.numero}
`;

}


/* =========================
   GANADOR EN VIVO
========================= */

onSnapshot(doc(db,"ganador","actual"),snap=>{

if(!snap.exists()) return;

const g=snap.data();

document.getElementById("ganador").innerHTML=
`
ğŸ† GANADOR<br>
${g.nombre}<br>
NÃºmero #${g.numero}
`;

});

</script>

</body>
</html>
